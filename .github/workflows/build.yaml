name: build-deploy

on:
  push:
    branches:
      - main
      - rev
      - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.actor }}/${{ vars.IMAGE }}:${{ github.ref_name }}
          platforms: linux/arm64/v8
          cache-from: type=registry,ref=ghcr.io/${{ github.actor }}/${{ vars.IMAGE }}:buildcache
          cache-to: type=inline,ref=ghcr.io/${{ github.actor }}/${{ vars.IMAGE }}:buildcache,mode=max
          build-args: |
            STAGE=${{ github.ref_name }}
            CMS_URL_DEV=${{ secrets.CMS_URL_DEV }}
            CMS_URL_REV=${{ secrets.CMS_URL_REV }}
            CMS_URL_MAIN=${{ secrets.CMS_URL_MAIN }}

  deployment:
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: copy deployment tar
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HZ_HOST }}
          username: ${{ secrets.HZ_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          overwrite: true
          source: "ci"
          target: "/root/fe/"
      - name: executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@v1.0.3
        env:
          USERNAME: ${{ github.actor }}
          ACTOR: ${{ github.actor }}
          REF_NAME: ${{ github.ref_name }}
          TOKEN: ${{ secrets.GH_TOKEN }}
          IMAGE: ${{ vars.IMAGE }}
        with:
          host: ${{ secrets.HZ_HOST }}
          username: ${{ secrets.HZ_SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          envs: >
            USERNAME,
            ACTOR,
            REF_NAME,
            TOKEN,
            IMAGE
          script: bash ./fe/ci/deployment.sh
